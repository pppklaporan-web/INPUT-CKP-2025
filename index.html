<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laporan Kegiatan Lembur - Cetak PDF</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body {
    font-family:"Segoe UI",Roboto,Arial,sans-serif;
    margin:16px;
    color:#222;
    background:#f7f9fb;
  }
  .wrap {
    max-width:900px;
    margin:0 auto;
  }
  h1 {
    color:#0b66c2;
    text-align:center;
    margin-bottom:20px;
  }
  form.card {
    background:#fff;
    border-radius:10px;
    padding:16px;
    box-shadow:0 4px 18px rgba(0,0,0,.06);
    margin-bottom:18px;
  }
  label {
    display:block;
    margin:10px 0 6px;
    font-weight:600;
  }
  input[type=text], textarea {
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
  }
  textarea {min-height:80px;resize:vertical}
  .row {display:flex;gap:12px;flex-wrap:wrap}
  .col {flex:1}
  .small {max-width:200px}
  button {
    background:#0b66c2;
    color:white;
    border:none;
    padding:12px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
  .actions {display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* area cetak */
  .paper {
    width:210mm;
    min-height:297mm;
    padding:20mm;
    background:white;
    margin:0 auto;
    color:#111;
    box-sizing:border-box;
  }
  .center{text-align:center}
  h2{margin:0 0 4px}
  table {
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:0.95rem;
  }
  th,td {
    border:1px solid #000;
    padding:6px 8px;
    vertical-align:top;
  }
  th {
    background:#f3f3f3;
    text-align:center;
  }
  td:first-child{text-align:center;width:6%}
  td:nth-child(2){width:24%}
  td:nth-child(3),td:nth-child(4){width:35%}

  /* foto di dalam tabel */
  .foto-cell{
    width:100%;
    max-width:300px;
    height:200px;
    object-fit:cover;
    border:1px solid #888;
    border-radius:6px;
    padding:3px;
    display:block;
    margin:4px auto;
  }

  /* tanda tangan */
  .sign-section{margin-top:40px;}
  .sign-row{display:flex;justify-content:space-between;flex-wrap:wrap;text-align:center;}
  .sign-col{width:45%;min-width:220px;}
  .sign-title{line-height:1.2;margin-bottom:60px;}
  .sign-col b{display:block;margin-top:60px}
  .smallprint{font-size:0.85rem;color:#444;margin-top:6px;text-align:right}
  @media (max-width:720px){
    .row{flex-direction:column}
    .sign-row{flex-direction:column;align-items:center}
    .sign-col{width:100%}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>LAPORAN KEGIATAN LEMBUR — Generator PDF</h1>

    <form id="form" class="card" onsubmit="return false;">
      <div class="row">
        <div class="col"><label>Hari</label><input id="hari" type="text" placeholder="Senin"></div>
        <div class="col small"><label>Tanggal</label><input id="tgl" type="text" placeholder="01"></div>
        <div class="col"><label>Bulan</label><input id="bulan" type="text" placeholder="Januari"></div>
        <div class="col small"><label>Tahun</label><input id="tahun" type="text" placeholder="2025"></div>
      </div>

      <label>Nama Pegawai</label>
      <input id="nama" type="text" placeholder="Masukkan nama lengkap" />

      <div class="row">
        <div class="col">
          <label>Rencana Pekerjaan</label>
          <textarea id="kegiatan" placeholder="Tuliskan rencana pekerjaan"></textarea>
        </div>
        <div class="col">
          <label>Hasil Lembur</label>
          <textarea id="hasil" placeholder="Tuliskan hasil kegiatan"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <label>Pelaksanaan Kegiatan (Foto 1)</label>
          <input id="foto1" type="file" accept="image/*" />
        </div>
        <div class="col">
          <label>Pelaksanaan Kegiatan (Foto 2)</label>
          <input id="foto2" type="file" accept="image/*" />
        </div>
      </div>

      <div class="actions">
        <button id="previewBtn" type="button">Tampilkan Preview</button>
        <button id="downloadBtn" type="button">Buat PDF / Cetak</button>
      </div>
    </form>

    <div id="previewWrap" style="display:none;background:#f7f7f7;padding:12px;border-radius:8px">
      <h3>Preview (akan tercetak seperti ini)</h3>
      <div id="paper" class="paper"></div>
    </div>
  </div>

<script>
function fileToDataURL(file){
  return new Promise((resolve)=>{
    if(!file){resolve(null);return;}
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

async function buildPaper(){
  const hari=document.getElementById('hari').value||'';
  const tgl=document.getElementById('tgl').value||'';
  const bulan=document.getElementById('bulan').value||'';
  const tahun=document.getElementById('tahun').value||'';
  const nama=document.getElementById('nama').value||'';
  const kegiatan=document.getElementById('kegiatan').value||'';
  const hasil=document.getElementById('hasil').value||'';
  const foto1=document.getElementById('foto1').files[0];
  const foto2=document.getElementById('foto2').files[0];
  const data1=await fileToDataURL(foto1);
  const data2=await fileToDataURL(foto2);

  const header=`<div class="center">
    <h2>LAPORAN KEGIATAN LEMBUR</h2>
    <div style="margin-top:6px"><b>${hari}, ${tgl} ${bulan} ${tahun}</b></div>
  </div>`;

  const table=`
  <table>
    <thead>
      <tr><th>No</th><th>Nama</th><th>Rencana Pekerjaan</th><th>Hasil Lembur</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td>${escape(nama)}</td>
        <td>${escape(kegiatan)}</td>
        <td>${escape(hasil)}</td>
      </tr>
      <tr>
        <td>2</td>
        <td><b>Pelaksanaan<br>Kegiatan</b></td>
        <td>${data1 ? `<img src="${data1}" class="foto-cell">` : ''}</td>
        <td>${data2 ? `<img src="${data2}" class="foto-cell">` : ''}</td>
      </tr>
    </tbody>
  </table>`;

  const sign=`
  <div class="sign-section">
    <div class="sign-row">
      <div class="sign-col">
        <div class="sign-title">
          Mengetahui,<br>
          Kepala Badan Pusat Statistik<br>
          Provinsi Sumatera Barat
        </div>
        <b>Sugeng Arianto</b>
      </div>
      <div class="sign-col">
        <div>Pelaksana Lembur,</div>
        <b>${escape(nama)}</b>
      </div>
    </div>
  </div>`;

  return `${header}${table}${sign}
  <div class="smallprint">Dicetak: ${new Date().toLocaleString('id-ID')}</div>`;
}

function escape(s){return String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}

/* ✅ Preview fix */
document.getElementById('previewBtn').addEventListener('click', async () => {
  const previewWrap = document.getElementById('previewWrap');
  const paper = document.getElementById('paper');
  paper.innerHTML = "<div style='text-align:center;padding:10px;color:#666;'>⏳ Membuat preview...</div>";
  previewWrap.style.display = 'block';
  setTimeout(async () => {
    const html = await buildPaper();
    paper.innerHTML = html;
    paper.scrollIntoView({ behavior: 'smooth' });
  }, 200);
});

/* ✅ Centered PDF output */
document.getElementById('downloadBtn').addEventListener('click',async()=>{
  const div=document.createElement('div');
  div.className='paper';
  div.innerHTML=await buildPaper();
  const opt={
    margin:[15,15,15,15],
    filename:`LAPORAN_LEMBUR_${(document.getElementById('nama').value||'').replaceAll(' ','_')}.pdf`,
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,scrollY:0,useCORS:true},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
    pagebreak:{mode:['avoid-all','css','legacy']}
  };
  document.getElementById('downloadBtn').textContent='Membuat PDF...';
  document.getElementById('downloadBtn').disabled=true;
  await html2pdf().set(opt).from(div).save();
  document.getElementById('downloadBtn').textContent='Buat PDF / Cetak';
  document.getElementById('downloadBtn').disabled=false;
});
</script>
</body>
</html>
