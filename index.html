<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Unggah File CKP 2025</title>
  <style>
    :root{--primary:#006eb6;--bg1:#eaf4fc;--bg2:#fff}
    body{font-family:Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:100%;max-width:480px;background:#fff;border-radius:16px;padding:28px;box-shadow:0 8px 24px rgba(0,0,0,0.08);text-align:center}
    .logo img{width:110px;height:auto;border-radius:8px;margin-bottom:8px}
    h2{color:var(--primary);margin:6px 0 18px}
    label{text-align:left;display:block;margin-top:12px;font-weight:600;color:#333}
    input[type=text],select,input[type=file]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:6px;box-sizing:border-box}
    .btn{width:100%;background:var(--primary);color:#fff;border:none;padding:12px;border-radius:8px;font-weight:700;margin-top:16px;cursor:pointer}
    .progress{height:10px;background:#f3f3f3;border-radius:8px;overflow:hidden;margin-top:12px;display:none}
    .bar{height:100%;width:0;background:var(--primary);transition:width .25s}
    .info{display:none;margin-top:14px;padding:12px;border-radius:8px;font-size:14px}
    .info.success{background:#e9f8ec;border:1px solid #2e7d32;color:#2e7d32}
    .info.error{background:#fdecea;border:1px solid #c62828;color:#c62828}
    footer{font-size:12px;color:#777;margin-top:14px}
  </style>
</head>
<body>
  <div class="card">
    
    <h2>Unggah File CKP 2025</h2>

    <label>Nama Pegawai</label>
    <input id="nama" type="text" placeholder="Masukkan nama lengkap">

    <label>Bulan (Folder Tujuan)</label>
    <select id="bulanSelect"></select>

    <label>File PDF</label>
    <input id="pdfFile" type="file" accept="application/pdf">

    <button class="btn" id="uploadBtn">Unggah Sekarang</button>

    <div class="progress" id="progress"><div class="bar" id="bar"></div></div>
    <div id="result" class="info"></div>

    <footer>¬© 2025 BPS Provinsi Sumatera Barat</footer>
  </div>

  <script>
    // load bulan dari server (getMonthFolders di Code.gs)
    google.script.run.withSuccessHandler(function(months){
      const sel = document.getElementById('bulanSelect');
      sel.innerHTML = '';
      months.forEach(m=>{
        const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o);
      });
    }).getMonthFolders();

    const uploadBtn = document.getElementById('uploadBtn');
    const progress = document.getElementById('progress');
    const bar = document.getElementById('bar');
    const result = document.getElementById('result');

    uploadBtn.addEventListener('click', ()=>{
      const nama = document.getElementById('nama').value.trim();
      const bulan = document.getElementById('bulanSelect').value;
      const fileInput = document.getElementById('pdfFile');
      result.style.display = 'none'; result.textContent = '';

      if(!nama) return alert('Silakan masukkan nama.');
      if(!bulan) return alert('Silakan pilih bulan.');
      if(!fileInput.files.length) return alert('Silakan pilih file PDF.');

      const file = fileInput.files[0];
      if(file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) return alert('Hanya file PDF yang diperbolehkan.');

      // Read file as base64 and call server
      const reader = new FileReader();
      reader.onloadstart = ()=>{ progress.style.display='block'; bar.style.width='5%'; result.style.display='none'; }
      reader.onprogress = (e)=>{ if(e.lengthComputable){ const p=Math.round((e.loaded/e.total)*100); bar.style.width=p+'%'; } }
      reader.onloadend = ()=>{ bar.style.width='100%'; }
      reader.onload = function(ev){
        const dataUrl = ev.target.result;
        const base64 = dataUrl.split(';base64,').pop();

        result.style.display='block';
        result.className='info';
        result.textContent='‚è≥ Mengunggah ke Google Drive...';

        // Panggil fungsi server uploadFile(b64, originalName, nama, bulan)
        google.script.run.withSuccessHandler(function(res){
          progress.style.display='none';
          if(res && res.success){
            result.className='info success';
            result.innerHTML = '‚úÖ '+res.message + '<br><b>'+res.fileName+'</b><br><a href="'+res.fileUrl+'" target="_blank">üîó Lihat di Drive</a>' +
              '<br><small>Diunggah: '+ new Date().toLocaleString('id-ID') +'</small>';
            document.getElementById('pdfFile').value=''; document.getElementById('nama').value='';
            bar.style.width='0%';
          } else {
            result.className='info error';
            result.textContent = '‚úñ Gagal: '+(res && res.message ? res.message : 'Terjadi kesalahan.');
          }
        }).uploadFile(base64, file.name, nama, bulan);
      };

      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
